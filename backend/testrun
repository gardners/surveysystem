#!/bin/bash
if [ -e lighttpd.conf.local ]; then
   conf=lighttpd.conf.local
else
   conf=lighttpd.conf
fi
if [ ! -e ../front/node_modules ]; then
   ( cd ../front ; npm install )
fi
echo "config file is $conf"
sudo cp ${conf} /etc/lighttpd/lighttpd.conf
sudo rm /var/log/lighttpd/error.log

make \
&& /usr/sbin/lighttpd -tt -f /etc/lighttpd/lighttpd.conf \
&& service lighttpd stop \
&& cp surveyfcgi /var/www/fastcgi \
&& service lighttpd start

#todo flexible position
if [[ $1 == "--skip-npm-build" ]]
then
    echo "running without npm build"
    exit
fi

echo "build front"
cd ../front && npm run build
